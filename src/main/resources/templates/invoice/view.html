<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Invoice #<span th:text="${invoice.invoiceId}"></span> - Ease2Bill</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Invoice #<span th:text="${invoice.invoiceId}"></span></h2>
            <div>
                <a th:href="@{/receipts/thermal/{id}(id=${invoice.invoiceId})}" class="btn btn-outline-secondary" target="_blank">Print Thermal</a>
                <a th:href="@{/receipts/a4/{id}(id=${invoice.invoiceId})}" class="btn btn-outline-primary" target="_blank">Print A4</a>
                <a th:href="@{/invoices}" class="btn btn-secondary">Back to List</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>Invoice Details</h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>Customer:</strong> <span th:text="${invoice.customer.name}"></span></p>
                                <p><strong>Phone:</strong> <span th:text="${invoice.customer.phone}"></span></p>
                                <p><strong>Date:</strong> <span th:text="${#temporals.format(invoice.invoiceDate, 'dd-MM-yyyy')}"></span></p>
                                <p><strong>Time:</strong> <span th:text="${#temporals.format(invoice.invoiceTime, 'HH:mm')}"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Generated By:</strong> <span th:text="${invoice.user.name}"></span></p>
                                <p><strong>Status:</strong> 
                                    <span th:if="${invoice.paymentStatus == 'PAID'}" class="badge bg-success">PAID</span>
                                    <span th:if="${invoice.paymentStatus == 'UNPAID'}" class="badge bg-warning">UNPAID</span>
                                    <span th:if="${invoice.paymentStatus == 'PARTIAL'}" class="badge bg-info">PARTIAL</span>
                                </p>
                                <p><strong>Bill Total:</strong> <span class="fw-bold">₹<span th:text="${invoice.totalAmt}"></span></span></p>
                                <p><strong>Total Savings:</strong> <span class="text-success">₹<span th:text="${invoice.totalSaved}"></span></span></p>
                            </div>
                        </div>

                        <h5>Items</h5>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Subtotal</th>
                                    <th>Savings</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${invoice.invoiceItems}">
                                    <td th:text="${item.product.name}"></td>
                                    <td th:text="${item.quantity}"></td>
                                    <td>₹<span th:text="${item.price}"></span></td>
                                    <td>₹<span th:text="${item.subtotal}"></span></td>
                                    <td>₹<span th:text="${item.subsaved}"></span></td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="text-end">
                            <h4>Grand Total: ₹<span th:text="${invoice.totalAmt}"></span></h4>
                            <h5 class="text-success">Total Savings: ₹<span th:text="${invoice.totalSaved}"></span></h5>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h6>Payment QR Code</h6>
                    </div>
                    <div class="card-body text-center">
                        <img th:if="${qrBase64Small}" 
                             th:src="@{'image/png;base64,' + ${qrBase64Small}}" 
                             alt="Payment QR Code" 
                             style="width: 150px; height: 150px; border: 1px solid #ddd; border-radius: 8px;" />
                        <p class="mt-2">Scan to pay ₹<span th:text="${invoice.totalAmt}"></span></p>
                        
                        <div class="mt-3">
                            <form th:if="${invoice.paymentStatus != 'PAID'}" th:action="@{/invoices/pay/{id}(id=${invoice.invoiceId})}" method="get">
                                <button type="submit" class="btn btn-success w-100">Mark as Paid</button>
                            </form>
                            <div th:if="${invoice.paymentStatus == 'PAID'}" class="alert alert-success">
                                ✅ Payment received!
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>